<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Real Tree Map</title>
  <link rel="stylesheet" href="real-tree-map.css">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <style>
    body {
      background: #0d0f0d url("https://raw.githubusercontent.com/boardwalkclay1/real_tree_guy/main/public/assets/icons/rtg-192.png")
        center center / cover no-repeat;
      background-attachment: scroll;
      min-height: 100vh;
      color: #e8ffe8;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Inter", sans-serif;
    }

    @media (min-width: 768px) {
      body { background-attachment: fixed; }
    }

    .shell {
      display: flex;
      gap: 20px;
      padding: 20px;
    }

    /* PHONE LAYOUT: filters above map */
    @media (max-width: 900px) {
      .shell {
        flex-direction: column;
      }
    }

    .left-panel {
      background: rgba(0,0,0,0.45);
      border: 2px solid #2e6b33;
      border-radius: 14px;
      padding: 20px;
      width: 320px;
    }

    @media (max-width: 900px) {
      .left-panel {
        width: 100%;
      }
    }

    .pill-row {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 15px;
    }

    .pill {
      padding: 10px 16px;
      border-radius: 20px;
      background: rgba(0,0,0,0.35);
      border: 2px solid #3f8b44;
      color: #d8ffd8;
      cursor: pointer;
      font-weight: 600;
    }

    .pill:hover {
      background: #3f8b44;
      transform: scale(1.05);
    }

    .map-wrap {
      flex: 1;
      background: rgba(0,0,0,0.35);
      border: 2px solid #2e6b33;
      border-radius: 14px;
      overflow: hidden;
      height: 75vh;
      box-shadow: 0 0 18px rgba(0,0,0,0.5);
    }

    @media (max-width: 900px) {
      .map-wrap {
        height: 70vh;
      }
    }

    #mapFrame {
      width: 100%;
      height: 100%;
      border: 0;
    }

    .status {
      margin-top: 10px;
      font-size: 0.95rem;
      opacity: 0.9;
    }

    .map-footer {
      padding: 10px;
      text-align: center;
      background: rgba(0,0,0,0.4);
      border-top: 2px solid #2e6b33;
    }

    .btn-primary,
    .btn-ghost {
      display: block;
      width: 100%;
      margin-top: 10px;
      padding: 12px;
      border-radius: 14px;
      font-weight: 700;
      cursor: pointer;
      text-align: center;
      text-decoration: none;
    }

    .btn-primary {
      background: #3f8b44;
      border: 3px solid #6aff6a;
      color: #e8ffe8;
    }

    .btn-ghost {
      background: rgba(0,0,0,0.25);
      border: 2px solid #3f8b44;
      color: #d8ffd8;
    }
  </style>
</head>

<body>

  <section class="shell">

    <!-- LEFT PANEL -->
    <div class="left-panel">
      <h2>Supply Finder</h2>

      <div id="locationStatus" class="status">Requesting location…</div>

      <label>Supply Filters</label>
      <div id="filterRow" class="pill-row">
        <button class="pill" data-type="Home Depot">Home Depot</button>
        <button class="pill" data-type="Lowe's">Lowe's</button>
        <button class="pill" data-type="Ace Hardware">Ace Hardware</button>
        <button class="pill" data-type="chainsaw repair shop">Chainsaw Shops</button>
        <button class="pill" data-type="woodworking supply store">Woodworking Stores</button>
        <button class="pill" data-type="wood dump site">Wood Dump Sites</button>
        <button class="pill" data-type="sawmill">Sawmills</button>
        <button class="pill" data-type="gas station">Gas Stations</button>
      </div>

      <label>Client Address (optional)</label>
      <input id="clientAddress" placeholder="123 Oak St, Yulee, FL">

      <button id="directionsFromUser" class="btn-primary">
        Directions: Me → Supply
      </button>

      <button id="directionsFromClient" class="btn-ghost">
        Directions: Client → Supply
      </button>

      <div class="status">
        Filter: <span id="activeFilterLabel">None</span>
      </div>
    </div>

    <!-- MAP -->
    <div class="map-wrap">
      <iframe id="mapFrame" loading="lazy"></iframe>

      <div class="map-footer">
        <a id="openInMaps" href="https://www.google.com/maps" target="_blank">Open in Google Maps</a>
      </div>
    </div>

  </section>

  <script type="module">
    import PocketBase from "https://esm.sh/pocketbase@0.21.1";
    const pb = new PocketBase("https://pocketbase-production-f2f5.up.railway.app");

    const mapFrame = document.getElementById("mapFrame");
    const locationStatus = document.getElementById("locationStatus");
    const filterRow = document.getElementById("filterRow");
    const activeFilterLabel = document.getElementById("activeFilterLabel");
    const directionsFromUserBtn = document.getElementById("directionsFromUser");
    const directionsFromClientBtn = document.getElementById("directionsFromClient");
    const clientAddressInput = document.getElementById("clientAddress");
    const openInMaps = document.getElementById("openInMaps");

    const DEFAULT_ZOOM = 14;

    function updateMap(type, lat, lng) {
      const q = `${type} near ${lat},${lng}`;
      const encoded = encodeURIComponent(q);

      mapFrame.src =
        `https://www.google.com/maps?q=${encoded}&z=${DEFAULT_ZOOM}&output=embed`;

      openInMaps.href =
        `https://www.google.com/maps/search/?api=1&query=${encoded}`;
    }

    function fallbackMap(type) {
      const q = `${type} near me`;
      const encoded = encodeURIComponent(q);

      mapFrame.src =
        `https://www.google.com/maps?q=${encoded}&z=13&output=embed`;

      openInMaps.href =
        `https://www.google.com/maps/search/?api=1&query=${encoded}`;

      locationStatus.textContent =
        "Location denied. Showing results near your device region.";
    }

    function requestLocation(type, cb) {
      navigator.geolocation.getCurrentPosition(
        pos => {
          const lat = pos.coords.latitude;
          const lng = pos.coords.longitude;
          locationStatus.textContent = `Location: ${lat.toFixed(4)}, ${lng.toFixed(4)}`;
          cb(lat, lng);
        },
        () => fallbackMap(type),
        { enableHighAccuracy: true, timeout: 8000, maximumAge: 0 }
      );
    }

    // INITIAL LOAD
    requestLocation("tree service supplies", (lat, lng) => {
      updateMap("tree service supplies", lat, lng);
    });

    // FILTERS
    filterRow.addEventListener("click", (e) => {
      const btn = e.target.closest(".pill");
      if (!btn) return;

      const type = btn.dataset.type;
      activeFilterLabel.textContent = type;

      requestLocation(type, (lat, lng) => updateMap(type, lat, lng));
    });

    // DIRECTIONS
    function buildDirectionsUrl(origin, destination) {
      return `https://www.google.com/maps/dir/?api=1&origin=${encodeURIComponent(origin)}&destination=${encodeURIComponent(destination)}`;
    }

    directionsFromUserBtn.addEventListener("click", () => {
      const type = activeFilterLabel.textContent;
      if (type === "None") return alert("Select a supply filter first.");

      requestLocation(type, (lat, lng) => {
        const origin = `${lat},${lng}`;
        window.open(buildDirectionsUrl(origin, type), "_blank");
      });
    });

    directionsFromClientBtn.addEventListener("click", () => {
      const client = clientAddressInput.value.trim();
      if (!client) return alert("Enter a client address first.");

      const type = activeFilterLabel.textContent;
      if (type === "None") return alert("Select a supply filter first.");

      window.open(buildDirectionsUrl(client, type), "_blank");
    });
  </script>

</body>
</html>
